name: Deploy

on:
  push:
    branches:
      - main   # trigger production deploy on merge to main
  workflow_dispatch:  # allow manual deploys from GitHub UI

jobs:
  # ──────────────────────────────────────────────────────────────
  # 1. Run CI checks before deploying
  # ──────────────────────────────────────────────────────────────
  ci:
    name: Run CI checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install & build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run lint --if-present
          npm run build
        env:
          NODE_ENV: production

      - name: Install & test backend
        working-directory: backend
        run: |
          npm ci
          npm test --if-present -- --ci --passWithNoTests

  # ──────────────────────────────────────────────────────────────
  # 2. Deploy Frontend to Vercel
  # ──────────────────────────────────────────────────────────────
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: ci
    environment:
      name: production
      url: ${{ steps.vercel-deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel environment info
        working-directory: frontend
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project for Vercel
        working-directory: frontend
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: vercel-deploy
        working-directory: frontend
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Print deployed URL
        run: echo "Frontend deployed to ${{ steps.vercel-deploy.outputs.url }}"

  # ──────────────────────────────────────────────────────────────
  # 3. Deploy Backend to VPS via SSH
  # ──────────────────────────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend (VPS)
    runs-on: ubuntu-latest
    needs: ci
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Copy backend files to server
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            ./backend/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/

      - name: Install dependencies & restart service
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}
            npm ci --omit=dev
            # Restart using PM2 (adjust app name to match yours)
            pm2 restart farmer-connect-backend || pm2 start index.js --name farmer-connect-backend
            pm2 save
          EOF

  # ──────────────────────────────────────────────────────────────
  # 4. Notify on success / failure
  # ──────────────────────────────────────────────────────────────
  notify:
    name: Notify Deploy Status
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    steps:
      - name: Deployment succeeded
        if: needs.deploy-frontend.result == 'success' && needs.deploy-backend.result == 'success'
        run: echo "✅ Both frontend and backend deployed successfully."

      - name: Deployment failed
        if: needs.deploy-frontend.result != 'success' || needs.deploy-backend.result != 'success'
        run: |
          echo "❌ Deployment failed."
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
          echo "Backend:  ${{ needs.deploy-backend.result }}"
          exit 1
